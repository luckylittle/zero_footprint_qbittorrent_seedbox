---
# tasks file for zero_footprint_qbittorrent_seedbox/05-security

- name: SECURITY | 5.1 Install packages
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: present
  become: true
  loop: "{{ security_required_rpms }}"
  tags:
    - security

- name: SECURITY | 5.2 Ensure SELinux is set to enforcing mode
  ansible.builtin.lineinfile:
    path: "/etc/selinux/config"
    regexp: '^SELINUX='
    line: "SELINUX=enforcing"
    backup: true
  become: true
  tags:
    - security

- name: SECURITY | 5.3 Restore Autobrr, Mkbrr & Sizechecker files default \
        SELinux security contexts
  ansible.builtin.command: "restorecon -Rv /usr/local/bin/"
  register: restorecon_usr_local_bin
  changed_when: "'Relabeled' in restorecon_usr_local_bin.stdout"
  become: true
  tags:
    - security

- name: SECURITY | 5.4 Ensure port 7474 is labeled with http_port_t for Autobrr
  community.general.seport:
    ports: "7474"
    proto: "tcp"
    setype: "http_port_t"
    state: present
  become: true
  tags:
    - security

- name: SECURITY | 5.5 Start service firewalld
  ansible.builtin.service:
    name: "firewalld"
    state: "started"
    enabled: true
  become: true
  tags:
    - security

- name: SECURITY | 5.6 Add ipv4_whitelist to a new firewalld zone "public"
  ansible.posix.firewalld:
    zone: "public"
    source: "{{ item }}"
    state: "enabled"
    permanent: true
  become: true
  notify:
    - "Reload firewalld"
  loop: "{{ ipv4_whitelist | split(' ') }}"
  tags:
    - security

- name: SECURITY | 5.7 Permit traffic in "default" zone for http service
  ansible.posix.firewalld:
    service: "http"
    permanent: true
    state: "enabled"
  become: true
  notify:
    - "Reload firewalld"
  loop:
    - "{{ ftp_port }}/tcp"
    - "{{ pasv_port_range }}/tcp"
  tags:
    - security

- name: SECURITY | 5.8 Permit traffic in "default" zone for qtorrent
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    state: "enabled"
  become: true
  notify:
    - "Reload firewalld"
  loop:
    - "{{ qtorrent_port }}/tcp"
    - "{{ qtorrent_port }}/udp"
  tags:
    - security

- name: SECURITY | 5.9 Deny traffic in "default" zone for cockpit and ssh
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: "disabled"
  become: true
  notify:
    - "Reload firewalld"
  loop:
    - "cockpit"
    - "ssh"
  tags:
    - security

- name: SECURITY | 5.10 Deny ICMP traffic in "default" zone
  ansible.posix.firewalld:
    icmp_block: "{{ item }}"
    permanent: true
    state: "enabled"
  become: true
  notify:
    - "Reload firewalld"
  loop:
    - "echo-request"
    - "echo-reply"
  tags:
    - security

- name: SECURITY | 5.11 Permit traffic in "limited" zone for various rtorrent, \
        vsftpd, autobrr ports
  ansible.posix.firewalld:
    zone: "limited"
    port: "{{ item }}"
    permanent: true
    state: "enabled"
  become: true
  notify:
    - "Reload firewalld"
  loop:
    - "{{ rtorrent_port }}/tcp"
    - "{{ rtorrent_port }}/udp"
    - "{{ ftp_port }}/tcp"
    - "{{ pasv_port_range }}/tcp"
  tags:
    - security

- name: SECURITY | 5.12 Permit traffic in "limited" zone for https, sshd service
  ansible.posix.firewalld:
    zone: "limited"
    service: "{{ item }}"
    permanent: true
    state: "enabled"
  become: true
  notify:
    - "Reload firewalld"
  loop:
    - "https"
    - "ssh"
  tags:
    - security

- name: SECURITY | 5.13 Template the configuration for SSHD
  ansible.builtin.template:
    src: "sshd/sshd_config.j2"
    dest: "{{ sshd_config_file }}"
    backup: true
    mode: "0600"
  become: true
  notify:
    - "Reload sshd"
  tags:
    - security

- name: SECURITY | 5.14 Disable shell history
  ansible.builtin.lineinfile:
    path: "/etc/profile"
    regexp: '^HISTSIZE=1000$'
    line: "HISTSIZE=0\nHISTFILE=/dev/null"
    backup: true
  become: true
  tags:
    - security

- name: SECURITY | 5.15 Configure restricted sudo for ansible_user
  community.general.sudoers:
    name: "ansible-{{ ansible_user }}-custom-sudo"
    user: "{{ ansible_user }}"
    commands: "{{ restricted_sudo_commands }}"
    nopassword: true
    state: "present"
  become: true
  tags:
    - security
